<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Skin Preview</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: linear-gradient(135deg, #1a2a3a 0%, #2c3e50 100%);
            touch-action: none;
        }

        #skin_container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        canvas {
            display: block;
        }

        #draw_mode_indicator {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-family: sans-serif;
            font-size: 14px;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .control-btn.active {
            background: #4CAF50;
            color: white;
        }
    </style>
</head>

<body>
    <div id="skin_container"></div>
    <div id="draw_mode_indicator">Rotate Mode - Tap button to draw</div>
    <div class="controls">
        <button class="control-btn" id="rotate_btn" onclick="setMode('rotate')">üîÑ</button>
        <button class="control-btn" id="draw_btn" onclick="setMode('draw')">‚úèÔ∏è</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/skinview3d@3.0.0/bundles/skinview3d.bundle.min.js"></script>
    <script>
        let skinViewer = null;
        let currentMode = 'rotate';
        let currentColor = '#FF0000';
        let skinCanvas = null;
        let skinCtx = null;

        function initViewer() {
            const container = document.getElementById('skin_container');

            // Create a canvas to hold the skin texture
            skinCanvas = document.createElement('canvas');
            skinCanvas.width = 64;
            skinCanvas.height = 64;
            skinCtx = skinCanvas.getContext('2d');

            // Fill with default gray
            skinCtx.fillStyle = '#C8C8C8';
            skinCtx.fillRect(0, 0, 64, 64);

            skinViewer = new skinview3d.SkinViewer({
                canvas: document.createElement('canvas'),
                width: container.clientWidth,
                height: container.clientHeight,
                skin: skinCanvas.toDataURL()
            });

            container.appendChild(skinViewer.canvas);

            // Enable rotation
            skinViewer.controls.enableRotate = true;
            skinViewer.controls.enableZoom = true;
            skinViewer.controls.enablePan = false;

            // Add idle animation
            skinViewer.animation = new skinview3d.IdleAnimation();
            skinViewer.animation.speed = 0.5;

            // Handle resize
            window.addEventListener('resize', () => {
                skinViewer.width = container.clientWidth;
                skinViewer.height = container.clientHeight;
            });

            // Handle drawing on the 3D model
            skinViewer.canvas.addEventListener('click', handleCanvasClick);
            skinViewer.canvas.addEventListener('touchstart', handleTouch, { passive: false });
            skinViewer.canvas.addEventListener('touchmove', handleTouch, { passive: false });

            updateModeUI();
        }

        function setMode(mode) {
            currentMode = mode;
            skinViewer.controls.enableRotate = (mode === 'rotate');
            updateModeUI();

            // Notify Flutter
            if (window.FlutterChannel) {
                window.FlutterChannel.postMessage(JSON.stringify({ type: 'mode_change', mode: mode }));
            }
        }

        function updateModeUI() {
            const indicator = document.getElementById('draw_mode_indicator');
            const rotateBtn = document.getElementById('rotate_btn');
            const drawBtn = document.getElementById('draw_btn');

            if (currentMode === 'rotate') {
                indicator.textContent = 'Rotate Mode - Drag to rotate';
                rotateBtn.classList.add('active');
                drawBtn.classList.remove('active');
            } else {
                indicator.textContent = 'Draw Mode - Tap on model to paint';
                rotateBtn.classList.remove('active');
                drawBtn.classList.add('active');
            }
        }

        function handleCanvasClick(event) {
            if (currentMode !== 'draw') return;

            const rect = skinViewer.canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            // Simple raycast - map screen position to approximate UV
            // This is a simplified version; proper raycasting requires Three.js raycaster
            const uv = screenToUV(x, y, rect.width, rect.height);
            if (uv) {
                paintAtUV(uv.u, uv.v);
            }
        }

        function handleTouch(event) {
            if (currentMode !== 'draw') return;
            event.preventDefault();

            const touch = event.touches[0];
            const rect = skinViewer.canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;

            const uv = screenToUV(x, y, rect.width, rect.height);
            if (uv) {
                paintAtUV(uv.u, uv.v);
            }
        }

        // Simplified screen to UV mapping
        // For proper implementation, use Three.js Raycaster
        function screenToUV(screenX, screenY, canvasWidth, canvasHeight) {
            // Normalize screen coordinates to -1 to 1
            const ndcX = (screenX / canvasWidth) * 2 - 1;
            const ndcY = -(screenY / canvasHeight) * 2 + 1;

            // Very rough approximation - assumes model is centered and roughly fills screen
            // Map to texture coordinates based on visible area
            // This is approximate; proper solution requires raycasting

            // Center region = face/front of body
            if (Math.abs(ndcX) < 0.3 && ndcY > 0 && ndcY < 0.5) {
                // Head front area (approx)
                const u = 8 + (ndcX + 0.3) / 0.6 * 8;
                const v = 8 + (0.5 - ndcY) / 0.5 * 8;
                return { u: Math.floor(u), v: Math.floor(v) };
            }

            if (Math.abs(ndcX) < 0.3 && ndcY < 0 && ndcY > -0.6) {
                // Body front area (approx)
                const u = 20 + (ndcX + 0.3) / 0.6 * 8;
                const v = 20 + (-ndcY) / 0.6 * 12;
                return { u: Math.floor(u), v: Math.floor(v) };
            }

            return null;
        }

        function paintAtUV(u, v) {
            if (u < 0 || u >= 64 || v < 0 || v >= 64) return;

            skinCtx.fillStyle = currentColor;
            skinCtx.fillRect(u, v, 1, 1);

            // Update the 3D model
            skinViewer.loadSkin(skinCanvas.toDataURL());

            // Notify Flutter of the paint
            if (window.FlutterChannel) {
                window.FlutterChannel.postMessage(JSON.stringify({
                    type: 'paint',
                    x: u,
                    y: v,
                    color: currentColor
                }));
            }
        }

        // Update skin texture from base64
        function updateSkin(base64Data) {
            const img = new Image();
            img.onload = function () {
                skinCtx.clearRect(0, 0, 64, 64);
                skinCtx.drawImage(img, 0, 0);
                if (skinViewer) {
                    skinViewer.loadSkin(skinCanvas.toDataURL());
                }
            };
            img.src = 'data:image/png;base64,' + base64Data;
        }

        // Set current drawing color from Flutter
        function setColor(hexColor) {
            currentColor = hexColor;
        }

        // Initialize when ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initViewer);
        } else {
            initViewer();
        }

        // Expose functions for Flutter
        window.updateSkin = updateSkin;
        window.setColor = setColor;
        window.setMode = setMode;
    </script>
</body>

</html>