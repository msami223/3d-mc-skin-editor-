<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minecraft Skin Editor</title>
    <!-- Use Local Library -->
    <script src="skinview3d.bundle.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: system-ui, sans-serif;
            color: white;
            touch-action: none;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        .top-bar {
            height: 60px;
            flex-shrink: 0;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .view-toggle {
            background: rgba(0, 0, 0, 0.2);
            padding: 4px;
            border-radius: 12px;
            display: flex;
            gap: 8px;
        }

        .toggle-btn {
            border: none;
            background: none;
            color: rgba(255, 255, 255, 0.7);
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .toggle-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .content {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            width: 100%;
        }

        #view2d,
        #view3d {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 0;
            left: 0;
        }

        .hidden {
            display: none !important;
        }

        .canvas-wrapper {
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            background: #2a2a2a;
        }

        #gridCanvas,
        #drawCanvas {
            position: absolute;
            top: 0;
            left: 0;
            image-rendering: pixelated;
            border-radius: 4px;
        }

        #gridCanvas {
            z-index: 1;
        }

        #drawCanvas {
            z-index: 2;
            cursor: crosshair;
        }

        #viewer3d {
            outline: none;
        }

        .mode-pill {
            position: absolute;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            pointer-events: none;
            z-index: 50;
        }

        .controls-area {
            flex-shrink: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .color-bar {
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            overflow-x: auto;
            white-space: nowrap;
        }

        .colors-scroll {
            display: flex;
            gap: 12px;
            padding: 0 20px;
            align-items: center;
        }

        .swatch {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.2);
            flex-shrink: 0;
        }

        .swatch.active {
            transform: scale(1.2);
            border-color: white;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        /* Rainbow Button for Custom Color */
        .swatch.rainbow {
            background: linear-gradient(135deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
            position: relative;
        }

        /* Hidden Color Input */
        #colorInput {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }

        .toolbar {
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .tool-group {
            display: flex;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px;
            border-radius: 12px;
        }

        .btn-tool {
            width: 44px;
            height: 44px;
            border: none;
            background: none;
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-tool.active {
            background: white;
            color: #667eea;
        }

        .btn-zoom {
            width: 40px;
            height: 40px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            color: white;
            font-size: 18px;
            margin-left: 4px;
        }

        .btn-zoom:active {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-zoom.active {
            background: #4CAF50;
            color: white;
        }

        /* Debug Console - HIDDEN */
        #debugConsole {
            display: none !important;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="top-bar">
            <div class="view-toggle">
                <button class="toggle-btn active" id="tab2d" onclick="setMode('2d')">üé® 2D Canvas</button>
                <button class="toggle-btn" id="tab3d" onclick="setMode('3d')">üßä 3D Preview</button>
            </div>
        </div>

        <!-- Debug Console -->
        <div id="debugConsole">Debugging...</div>

        <div class="content">
            <!-- 2D View -->
            <div id="view2d">
                <div class="canvas-wrapper" id="canvasWrapper">
                    <canvas id="gridCanvas"></canvas>
                    <canvas id="drawCanvas"></canvas>
                </div>
                <div class="mode-pill" id="modeLabel">‚úèÔ∏è Draw Mode</div>
            </div>

            <!-- 3D View -->
            <div id="view3d" class="hidden">
                <canvas id="viewer3d"></canvas>
                <div class="mode-pill">Use one finger to rotate</div>
            </div>
        </div>

        <div class="controls-area">
            <!-- Color Bar -->
            <div class="color-bar">
                <div class="colors-scroll" id="colorPalette">
                    <!-- Injected via JS -->
                </div>
            </div>

            <!-- Toolbar -->
            <div class="toolbar">
                <div class="tool-group">
                    <button class="btn-tool active" onclick="setTool('pencil')" id="btnPencil">‚úèÔ∏è</button>
                    <button class="btn-tool" onclick="setTool('eraser')" id="btnEraser">üßπ</button>
                    <button class="btn-tool rainbow-btn" onclick="document.getElementById('colorInput').click()"
                        id="btnRainbow">üåà</button>
                    <input type="color" id="colorInput" onchange="setColor(this.value)"
                        style="position:absolute;opacity:0;pointer-events:none;">
                </div>

                <div style="display: flex; align-items: center;">
                    <button class="btn-zoom" onclick="zoomIdx(-1)">-</button>
                    <button class="btn-zoom" onclick="zoomIdx(1)">+</button>
                    <button class="btn-zoom" onclick="resetView()">‚äô</button>
                    <button class="btn-zoom" id="btnPan" onclick="togglePan()">‚úã</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Utils
        function log(msg) {
            console.log(msg);
        }
        window.onerror = function (msg, url, line) {
            console.error("JS Error: " + msg + " line " + line);
        };

        const SKIN_SIZE = 64;
        const DEFAULT_COLORS = ['#ef5350', '#ab47bc', '#5c6bc0', '#29b6f6', '#26a69a', '#9ccc65', '#ffca28', '#ffa726', '#8d6e63', '#212121', '#ffffff'];
        const BASE64_STEVE = "iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAFDUlEQVR42u2aT0wcVRzHf7O7lJYqtCDQ2gcTicbE1IQUY6KYSExIfDCTi4n2wIsJ1YPhQvRgsDHRmBgT7YmnJqY81JMmJt408c9qYhQRS2lLaVNsC8u/2d3xNzO7O8vO/N97s4v7JpubzLyZ9/283/u935uZjI2NjeA9HyLi8Xg8Ho/H4/F4vD7vW15e5tlslsnJSbLZbO//2aX/3/X19eX9wsICg4OD9/0cAB8APgB8APgA8AHgA8AHgA8AHwA+AHwA+ADwAeADwAeADwAfAD4APAB4APAB4APAB+gCj6A3+8nFArR1NREa2srnZ2ddHZ24vf7iUQi1NbW0tTUxPz8/F19siyLjY0NlpaWKBQKd4wlk0my2SzJZJJsNsuFCxdIJpP39AmFQnR1ddHb20tHRwdtbW3U1dURUQd5B/f393nmmWd4/fXXya/k+eKzL/n2u2/uGEsmkySTSZavLlMsFu/pU1tby9DQEIMDg/T39z/Q54Xnn+fFl17k5RefJ9wV5pOPP+KTj/68YywWi5FMJvn1t19va9ze3ua5555jZGSExx9//IE9W1tbdHZ20tnZSSAQIJvN8tlnn/HRRx/dMba2tsbS0hLhcJi1tbW/9AmFQgwNDTE8PEx/f/8DfcLhMK2trbS2trK8vMznX3zO448/fvtYIpEgGo3y6aef/qVPd3c3Ivt/R/b/9/b2Eo1GefNPN2/f+62trad48cUXmZqaIhaL3TGWy+V46aWXeOuttxgbG7ujT11dHR0dHUQikQf2tLS0AFBXV8fa2hqvv/767Xv/4YcfsrS0xOTkJD/88MOdY4lEgmQyyfT0NMlksqI+wWCQvr4+BgYGqK+vv2/PxsYG6+vrrK2tkU6nGRsbu33vP/74Y0ZHR3n11Vd57bXX7hxLJBIkEgleffVVkslkrT41NTW0trbS1tZ2357V1VXS6TSZTIaFhQV+++232/d+cnKSSCTC6Ogozz///J1jiUSCaDTK5OQkX3zxxV19qqurCYfDBIPB+//wr6+TzWYpFArMzMzcsff5fJ5oNMr4+DgTExN3jMViMWKxGK+99hqffvpprT7V1dWEw2GCwSAtLS339MlkMqTTaVZXV/ntt9/u2Pv8/DwjIyOMjY0xNTV1x9ja2hqxWIzR0VFisRitrb/3qampIRQKEQwG/9YnmUxSKBSYnJy8Y+/z+TyTk5OMjY0xOTl5x1g8Huf1119nbGyMUCj0wJ66ujoiKnt/f/+9fTY3N8lms6TTaeRyufv2/vvvv0xMTDA+Ps7MzMwdY6lUimg0Ots5OAA+AHwA+ADwAeADwAeADwAeADwAfAD4APAB8APgA8AHgA8AHwA+ADwAeADwAeADwAeADwAeADwAeADwAeADwAeADwAeADwAeADwAeADwAeADwAeADwAeADwAeADwAeADwAeADwAeADwAeAD/B/AP4G2i7fC27705gAAAAASUVORK5CYII=";

        let state = {
            mode: '2d',
            tool: 'pencil',
            color: '#ef5350',
            scale: 1.0,
            pan: { x: 0, y: 0 },
            isPanMode: false,
            pixelSize: 0,
            canvasSize: 0
        };

        let viewer;
        let gridCtx, drawCtx;
        let isDrawing = false;
        let isPanning = false;
        let lastPoint = null;
        let startPan = { x: 0, y: 0 };

        const els = {
            gridCanvas: document.getElementById('gridCanvas'),
            drawCanvas: document.getElementById('drawCanvas'),
            canvasWrapper: document.getElementById('canvasWrapper'),
            colorPalette: document.getElementById('colorPalette'),
            modeLabel: document.getElementById('modeLabel'),
        };

        function init() {
            try {
                const container = document.querySelector('.content');
                if (container.clientWidth === 0) {
                    setTimeout(init, 100);
                    return;
                }

                const size = Math.min(container.offsetWidth, container.offsetHeight) - 40;
                state.canvasSize = size;
                state.pixelSize = size / SKIN_SIZE;

                els.canvasWrapper.style.width = size + 'px';
                els.canvasWrapper.style.height = size + 'px';

                els.gridCanvas.width = size;
                els.gridCanvas.height = size;
                els.drawCanvas.width = size;
                els.drawCanvas.height = size;

                gridCtx = els.gridCanvas.getContext('2d');
                drawCtx = els.drawCanvas.getContext('2d');
                drawCtx.imageSmoothingEnabled = false;

                drawGrid();
                renderColors();

                els.drawCanvas.addEventListener('pointerdown', onDown);
                window.addEventListener('pointermove', onMove);
                window.addEventListener('pointerup', onUp);

                log('2D Canvas initialized');

                // Try to init 3D safely
                setTimeout(init3D, 500);
            } catch (e) {
                log('Init Error: ' + e.message);
            }
        }

        function renderColors() {
            try {
                const html = DEFAULT_COLORS.map(c =>
                    `<div class="swatch ${state.color === c ? 'active' : ''}" 
                      style="background: ${c}" 
                      onclick="setColor('${c}')"></div>`
                ).join('');

                els.colorPalette.innerHTML = html;
                log('Colors rendered');
            } catch (e) {
                log('Error rendering colors: ' + e.message);
            }
        }

        function setColor(color) {
            state.color = color;
            // Don't re-render entire palette to keep focus
            // just update active class if it matches
            document.querySelectorAll('.swatch').forEach(el => {
                el.classList.remove('active');
                // Check if the swatch's background color matches the new color
                // This is a simple check and might not be robust for all color formats
                if (el.style.backgroundColor === color) {
                    el.classList.add('active');
                }
            });

            // Also if we picked from native, maybe update the rainbow swatch? No need.
            setTool('pencil');
        }

        function setTool(tool) {
            state.tool = tool;
            document.querySelectorAll('.btn-tool').forEach(b => b.classList.remove('active'));
            if (tool === 'pencil') document.getElementById('btnPencil').classList.add('active');
            if (tool === 'eraser') document.getElementById('btnEraser').classList.add('active');

            if (state.isPanMode) togglePan();
        }

        function setMode(mode) {
            state.mode = mode;
            document.getElementById('tab2d').classList.toggle('active', mode === '2d');
            document.getElementById('tab3d').classList.toggle('active', mode === '3d');
            document.getElementById('view2d').classList.toggle('hidden', mode !== '2d');
            document.getElementById('view3d').classList.toggle('hidden', mode !== '3d');

            if (mode === '3d') {
                if (viewer) {
                    const el = document.getElementById('view3d');
                    viewer.setSize(el.clientWidth, el.clientHeight);
                    update3DSkin();
                } else {
                    init3D();
                }
            }
        }

        function togglePan() {
            state.isPanMode = !state.isPanMode;
            document.getElementById('btnPan').classList.toggle('active', state.isPanMode);
            els.drawCanvas.style.cursor = state.isPanMode ? 'grab' : 'crosshair';
            els.modeLabel.innerText = state.isPanMode ? '‚úã Pan to Move' : '‚úèÔ∏è Draw Mode';
        }

        function drawGrid() {
            gridCtx.fillStyle = '#cfd8dc';
            gridCtx.fillRect(0, 0, state.canvasSize, state.canvasSize);
            gridCtx.beginPath();
            gridCtx.strokeStyle = 'rgba(255,255,255, 0.3)';
            gridCtx.lineWidth = 1;
            for (let i = 0; i <= SKIN_SIZE; i++) {
                const pos = i * state.pixelSize;
                gridCtx.moveTo(pos, 0);
                gridCtx.lineTo(pos, state.canvasSize);
                gridCtx.moveTo(0, pos);
                gridCtx.lineTo(state.canvasSize, pos);
            }
            gridCtx.stroke();
        }

        function getCoords(e) {
            const rect = els.drawCanvas.getBoundingClientRect();
            const x = Math.floor((e.clientX - rect.left) / (state.pixelSize * state.scale));
            const y = Math.floor((e.clientY - rect.top) / (state.pixelSize * state.scale));
            return { x, y };
        }

        function onDown(e) {
            if (state.mode !== '2d') return;

            if (state.isPanMode) {
                isPanning = true;
                startPan = { x: e.clientX - state.pan.x, y: e.clientY - state.pan.y };
                els.drawCanvas.style.cursor = 'grabbing';
                return;
            }

            const { x, y } = getCoords(e);
            isDrawing = true;
            paint(x, y);
            lastPoint = { x, y };
        }

        function onMove(e) {
            if (isPanning) {
                e.preventDefault();
                state.pan.x = e.clientX - startPan.x;
                state.pan.y = e.clientY - startPan.y;
                applyTransform();
                return;
            }

            if (!isDrawing) return;
            e.preventDefault();
            const { x, y } = getCoords(e);
            if (lastPoint) line(lastPoint.x, lastPoint.y, x, y);
            lastPoint = { x, y };
        }

        function onUp() {
            isDrawing = false;
            if (isPanning) {
                isPanning = false;
                if (state.isPanMode) els.drawCanvas.style.cursor = 'grab';
            }
            lastPoint = null;
            if (!isPanning && state.mode === '3d') update3DSkin();
        }

        function pickColor(x, y) {
            const px = Math.floor(x * state.pixelSize + state.pixelSize / 2);
            const py = Math.floor(y * state.pixelSize + state.pixelSize / 2);
            const p = drawCtx.getImageData(px, py, 1, 1).data;
            if (p[3] > 0) {
                const hex = "#" + ((1 << 24) + (p[0] << 16) + (p[1] << 8) + p[2]).toString(16).slice(1);
                setColor(hex);
            }
        }

        function paint(x, y) {
            if (x < 0 || x >= SKIN_SIZE || y < 0 || y >= SKIN_SIZE) return;
            if (state.tool === 'eraser') {
                drawCtx.clearRect(x * state.pixelSize, y * state.pixelSize, state.pixelSize, state.pixelSize);
            } else if (state.tool === 'pencil') {
                drawCtx.fillStyle = state.color;
                drawCtx.fillRect(x * state.pixelSize, y * state.pixelSize, state.pixelSize, state.pixelSize);
            }
        }

        function line(x0, y0, x1, y1) {
            const dx = Math.abs(x1 - x0);
            const dy = Math.abs(y1 - y0);
            const sx = (x0 < x1) ? 1 : -1;
            const sy = (y0 < y1) ? 1 : -1;
            let err = dx - dy;
            while (true) {
                paint(x0, y0);
                if ((x0 === x1) && (y0 === y1)) break;
                const e2 = 2 * err;
                if (e2 > -dy) { err -= dy; x0 += sx; }
                if (e2 < dx) { err += dx; y0 += sy; }
            }
        }

        function zoomIdx(dir) {
            const levels = [0.5, 0.75, 1.0, 1.5, 2.0, 3.0, 4.0];
            let curr = state.scale;
            let idx = 2; // default
            let minDiff = 100;
            levels.forEach((l, i) => { if (Math.abs(l - curr) < minDiff) { minDiff = Math.abs(l - curr); idx = i; } });
            idx = Math.max(0, Math.min(levels.length - 1, idx + dir));
            state.scale = levels[idx];
            applyTransform();
        }

        function resetView() {
            state.scale = 1.0;
            state.pan = { x: 0, y: 0 };
            applyTransform();
        }

        function applyTransform() {
            els.canvasWrapper.style.transform = `translate(${state.pan.x}px, ${state.pan.y}px) scale(${state.scale})`;
        }

        function init3D() {
            log('>>> init3D called');

            log('Checking skinview3d library...');
            if (typeof skinview3d === 'undefined') {
                log("ERROR: skinview3d library not loaded!");
                return;
            }
            log('‚úì skinview3d library found');

            log('Getting viewer3d canvas element...');
            const el = document.getElementById('viewer3d');
            if (!el) {
                log('ERROR: viewer3d canvas not found!');
                return;
            }
            log('‚úì viewer3d canvas found');

            log('Getting view3d container...');
            const container = document.getElementById('view3d');
            if (!container) {
                log('ERROR: view3d container not found!');
                return;
            }
            const w = container.clientWidth || 300;
            const h = container.clientHeight || 400;
            log(`‚úì Container size: ${w}x${h}`);

            try {
                log(`Creating SkinViewer instance...`);
                viewer = new skinview3d.SkinViewer({
                    canvas: el,
                    width: w,
                    height: h,
                });
                log('‚úì SkinViewer created');

                log('Setting zoom to 0.8...');
                viewer.zoom = 0.8;
                log('‚úì Zoom set');

                log('Setting IdleAnimation...');
                viewer.animation = new skinview3d.IdleAnimation();
                log('‚úì Animation set');

                log('Calling update3DSkin...');
                update3DSkin();
                log('‚úì init3D complete');

            } catch (e) {
                log(`ERROR in init3D: ${e.name}: ${e.message}`);
                log(`Stack: ${e.stack}`);
            }
        }

        function update3DSkin() {
            log('>>> update3DSkin called');

            if (!viewer) {
                log('ERROR: viewer is null/undefined');
                return;
            }
            log('‚úì Viewer exists');

            try {
                log('Creating temp canvas...');
                const temp = document.createElement('canvas');
                temp.width = 64;
                temp.height = 64;
                log('‚úì Temp canvas created: 64x64');

                log('Getting 2d context...');
                const ctx = temp.getContext('2d');
                if (!ctx) {
                    log('ERROR: Failed to get 2d context');
                    return;
                }
                log('‚úì Context acquired');

                // Fill with a solid skin tone color as base
                log('Filling with default skin color...');
                ctx.fillStyle = '#ECCBB9'; // Light tan skin color
                ctx.fillRect(0, 0, 64, 64);
                log('‚úì Base color filled');

                log(`Drawing user canvas (${state.canvasSize}x${state.canvasSize})...`);
                ctx.drawImage(els.drawCanvas, 0, 0, state.canvasSize, state.canvasSize, 0, 0, 64, 64);
                log('‚úì User drawing overlaid');

                log('Converting to data URL...');
                const dataUrl = temp.toDataURL();
                log(`‚úì Data URL created (length: ${dataUrl.length})`);

                log('Loading skin to viewer...');
                viewer.loadSkin(dataUrl);
                log('‚úì Skin loaded to viewer!');

            } catch (e) {
                log(`ERROR in update3DSkin: ${e.name}: ${e.message}`);
                log(`Stack: ${e.stack}`);
            }
        }

        // Import texture from gallery (called from Flutter)
        function loadSkin(base64Data) {
            try {
                log('Loading skin from gallery...');
                const img = new Image();
                img.onload = () => {
                    // Clear current canvas
                    drawCtx.clearRect(0, 0, state.canvasSize, state.canvasSize);

                    // Draw imported image scaled to canvas
                    drawCtx.drawImage(img, 0, 0, state.canvasSize, state.canvasSize);
                    log('Skin loaded successfully');

                    // Update 3D
                    if (state.mode === '3d') {
                        update3DSkin();
                    }
                };
                img.onerror = () => {
                    console.error('Failed to load skin image');
                };
                img.src = 'data:image/png;base64,' + base64Data;
            } catch (e) {
                console.error('Error in loadSkin:', e);
            }
        }

        // Save current canvas as PNG with white background
        function saveImage() {
            try {
                log('Saving image...');
                const temp = document.createElement('canvas');
                temp.width = 64;
                temp.height = 64;
                const ctx = temp.getContext('2d');

                // Fill with WHITE background (no transparency)
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, 64, 64);

                // Draw user's drawing on top
                ctx.drawImage(els.drawCanvas, 0, 0, state.canvasSize, state.canvasSize, 0, 0, 64, 64);

                // Return as base64 PNG
                const dataUrl = temp.toDataURL('image/png');
                return dataUrl.split(',')[1]; // Return only base64 part
            } catch (e) {
                console.error('Error saving image:', e);
                return null;
            }
        }

        window.addEventListener('load', init);
        window.addEventListener('resize', () => { /* optional */ });

    </script>
</body>

</html>