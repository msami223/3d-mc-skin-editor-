<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minecraft Skin Editor</title>
    <script src="https://cdn.jsdelivr.net/npm/skinview3d@latest/bundles/skinview3d.bundle.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #1a2a3a;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            color: white;
            touch-action: none;
        }

        .container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Top toolbar */
        .toolbar {
            height: 50px;
            background: #0d1a26;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .view-toggle {
            display: flex;
            gap: 5px;
        }

        .toggle-btn {
            padding: 6px 16px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            font-size: 13px;
        }

        .toggle-btn.active {
            background: #4CAF50;
        }

        /* Main content area */
        .content {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
        }

        /* Left sidebar - tools */
        .left-sidebar {
            width: 60px;
            background: #0d1a26;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
            gap: 8px;
        }

        .tool-btn {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .tool-btn.active {
            background: #2196F3;
        }

        .tool-icon {
            font-size: 20px;
            margin-bottom: 2px;
        }

        .tool-divider {
            width: 40px;
            height: 1px;
            background: rgba(255, 255, 255, 0.2);
        }

        /* Right sidebar - colors */
        .right-sidebar {
            width: 60px;
            background: #0d1a26;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
            gap: 6px;
        }

        .color-swatch {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .color-swatch.active {
            border-color: white;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
        }

        /* Canvas area */
        .canvas-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        #canvas2d {
            background: #222;
            cursor: crosshair;
            image-rendering: pixelated;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
        }

        #viewer3d {
            border-radius: 8px;
        }

        .hidden {
            display: none !important;
        }

        /* Zoom controls */
        .zoom-controls {
            position: absolute;
            bottom: 16px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        /* Mode indicator */
        .mode-indicator {
            position: absolute;
            top: 12px;
            left: 12px;
            padding: 6px 12px;
            border-radius: 16px;
            background: rgba(0, 0, 0, 0.7);
            font-size: 11px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Top toolbar -->
        <div class="toolbar">
            <div class="view-toggle">
                <button class="toggle-btn active" id="btn2D" onclick="switchView('2d')">‚úèÔ∏è 2D Canvas</button>
                <button class="toggle-btn" id="btn3D" onclick="switchView('3d')">üë§ 3D Preview</button>
            </div>
        </div>

        <!-- Main content -->
        <div class="content">
            <!-- Left sidebar -->
            <div class="left-sidebar">
                <button class="tool-btn active" data-tool="pencil" onclick="selectTool('pencil')">
                    <div class="tool-icon">‚úèÔ∏è</div>
                    <div>Draw</div>
                </button>
                <button class="tool-btn" data-tool="eraser" onclick="selectTool('eraser')">
                    <div class="tool-icon">üßπ</div>
                    <div>Erase</div>
                </button>
                <button class="tool-btn" data-tool="fill" onclick="selectTool('fill')">
                    <div class="tool-icon">üé®</div>
                    <div>Fill</div>
                </button>
                <button class="tool-btn" data-tool="picker" onclick="selectTool('picker')">
                    <div class="tool-icon">üíâ</div>
                    <div>Pick</div>
                </button>
            </div>

            <!-- Canvas area -->
            <div class="canvas-area">
                <!-- 2D Canvas -->
                <div id="view2d">
                    <canvas id="canvas2d"></canvas>
                    <div class="mode-indicator" id="mode2d">‚úèÔ∏è Draw Mode</div>
                    <div class="zoom-controls">
                        <button class="zoom-btn" onclick="zoom(1.5)">+</button>
                        <button class="zoom-btn" onclick="zoom(0.67)">‚àí</button>
                        <button class="zoom-btn" onclick="resetZoom()">‚äô</button>
                    </div>
                </div>

                <!-- 3D Viewer -->
                <div id="view3d" class="hidden">
                    <canvas id="viewer3d"></canvas>
                    <div class="mode-indicator" id="mode3d">üîÑ Rotate Mode</div>
                    <div class="zoom-controls">
                        <button class="zoom-btn" onclick="toggle3DDrawMode()"
                            style="width: auto; padding: 8px 12px; font-size: 11px;">
                            ‚úèÔ∏è Draw
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right sidebar -->
            <div class="right-sidebar" id="colorPalette"></div>
        </div>
    </div>

    <script>
        // State
        let skinCanvas = null;
        let ctx = null;
        let viewer = null;
        let currentTool = 'pencil';
        let currentColor = '#FF0000';
        let painting = false;
        let scale = 1.0;
        let offsetX = 0;
        let offsetY = 0;
        let lastX = null;
        let lastY = null;
        let is3DDrawMode = false;
        let painting3D = false;

        // Make canvas responsive to screen size
        const CANVAS_SIZE = Math.min(window.innerWidth - 140, 400); // Account for sidebars (60px each + padding)
        const SKIN_SIZE = 64;
        const PIXEL_SIZE = CANVAS_SIZE / SKIN_SIZE;

        // Color palette
        const colors = [
            '#FF0000', '#FF7F00', '#FFFF00', '#00FF00', '#0000FF',
            '#4B0082', '#8B4513', '#000000', '#FFFFFF', '#808080'
        ];

        // Initialize
        function init() {
            skinCanvas = document.getElementById('canvas2d');
            skinCanvas.width = CANVAS_SIZE;
            skinCanvas.height = CANVAS_SIZE;
            ctx = skinCanvas.getContext('2d');

            // Fill with default gray
            ctx.fillStyle = '#C8C8C8';
            ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
            drawGrid();

            // Setup color palette
            const palette = document.getElementById('colorPalette');
            colors.forEach((color, i) => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch' + (i === 0 ? ' active' : '');
                swatch.style.backgroundColor = color;
                swatch.onclick = () => selectColor(color, swatch);
                palette.appendChild(swatch);
            });

            // Setup canvas events
            skinCanvas.addEventListener('mousedown', onPointerDown);
            skinCanvas.addEventListener('mousemove', onPointerMove);
            skinCanvas.addEventListener('mouseup', onPointerUp);
            skinCanvas.addEventListener('touchstart', onPointerDown, { passive: false });
            skinCanvas.addEventListener('touchmove', onPointerMove, { passive: false });
            skinCanvas.addEventListener('touchend', onPointerUp);

            // Initialize 3D viewer
            init3D();
        }

        function init3D() {
            const container = document.querySelector('.canvas-area');
            const maxWidth = Math.min(container.clientWidth - 40, 350);
            const maxHeight = Math.min(container.clientHeight - 40, 450);

            viewer = new skinview3d.SkinViewer({
                canvas: document.getElementById('viewer3d'),
                width: maxWidth,
                height: maxHeight,
                skin: getDataURL()
            });
            viewer.zoom = 0.9;
            viewer.autoRotate = false; // Manual rotation only
            viewer.controls.enableRotate = true;
            viewer.animation = new skinview3d.IdleAnimation();

            // Setup 3D drawing events
            const canvas3d = document.getElementById('viewer3d');
            canvas3d.addEventListener('pointerdown', on3DPointerDown);
            canvas3d.addEventListener('pointermove', on3DPointerMove);
            canvas3d.addEventListener('pointerup', on3DPointerUp);
        }

        function drawGrid() {
            // Minor grid
            ctx.strokeStyle = 'rgba(255,255,255,0.15)';
            ctx.lineWidth = 0.5;
            for (let i = 1; i < SKIN_SIZE; i++) {
                if (i % 8 !== 0) {
                    ctx.beginPath();
                    ctx.moveTo(i * PIXEL_SIZE, 0);
                    ctx.lineTo(i * PIXEL_SIZE, CANVAS_SIZE);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(0, i * PIXEL_SIZE);
                    ctx.lineTo(CANVAS_SIZE, i * PIXEL_SIZE);
                    ctx.stroke();
                }
            }

            // Major grid
            ctx.strokeStyle = 'rgba(255,255,255,0.4)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= SKIN_SIZE; i += 8) {
                ctx.beginPath();
                ctx.moveTo(i * PIXEL_SIZE, 0);
                ctx.lineTo(i * PIXEL_SIZE, CANVAS_SIZE);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(0, i * PIXEL_SIZE);
                ctx.lineTo(CANVAS_SIZE, i * PIXEL_SIZE);
                ctx.stroke();
            }
        }

        function getPixelCoords(e) {
            const rect = skinCanvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const x = Math.floor((clientX - rect.left) / PIXEL_SIZE);
            const y = Math.floor((clientY - rect.top) / PIXEL_SIZE);
            return { x: Math.max(0, Math.min(SKIN_SIZE - 1, x)), y: Math.max(0, Math.min(SKIN_SIZE - 1, y)) };
        }

        function paintPixel(x, y) {
            ctx.fillStyle = currentTool === 'eraser' ? '#C8C8C8' : currentColor;
            ctx.fillRect(x * PIXEL_SIZE, y * PIXEL_SIZE, PIXEL_SIZE, PIXEL_SIZE);
        }

        function onPointerDown(e) {
            e.preventDefault();
            painting = true;
            const { x, y } = getPixelCoords(e);

            if (currentTool === 'picker') {
                const pixel = ctx.getImageData(x * PIXEL_SIZE + 1, y * PIXEL_SIZE + 1, 1, 1).data;
                const hex = '#' + ((1 << 24) + (pixel[0] << 16) + (pixel[1] << 8) + pixel[2]).toString(16).slice(1);
                selectColor(hex);
                painting = false;
                return;
            }

            if (currentTool === 'fill') {
                floodFill(x, y);
                drawGrid();
                notifyFlutter();
                painting = false;
                return;
            }

            lastX = x;
            lastY = y;
            paintPixel(x, y);
        }

        function onPointerMove(e) {
            if (!painting || currentTool === 'picker' || currentTool === 'fill') return;
            e.preventDefault();
            const { x, y } = getPixelCoords(e);

            if (lastX !== null && lastY !== null) {
                drawLine(lastX, lastY, x, y);
            }
            lastX = x;
            lastY = y;
        }

        function onPointerUp(e) {
            if (painting) {
                painting = false;
                lastX = null;
                lastY = null;
                drawGrid();
                notifyFlutter();
            }
        }

        function drawLine(x0, y0, x1, y1) {
            const dx = Math.abs(x1 - x0);
            const dy = Math.abs(y1 - y0);
            const sx = x0 < x1 ? 1 : -1;
            const sy = y0 < y1 ? 1 : -1;
            let err = dx - dy;

            while (true) {
                paintPixel(x0, y0);
                if (x0 === x1 && y0 === y1) break;
                const e2 = 2 * err;
                if (e2 > -dy) { err -= dy; x0 += sx; }
                if (e2 < dx) { err += dx; y0 += sy; }
            }
        }

        function floodFill(x, y) {
            const imageData = ctx.getImageData(0, 0, CANVAS_SIZE, CANVAS_SIZE);
            const data = imageData.data;
            const targetColor = getColorAt(data, x * PIXEL_SIZE, y * PIXEL_SIZE);
            const fillColor = hexToRgb(currentTool === 'eraser' ? '#C8C8C8' : currentColor);

            if (colorsEqual(targetColor, fillColor)) return;

            const stack = [{ x: x * PIXEL_SIZE, y: y * PIXEL_SIZE }];

            while (stack.length) {
                const { x: px, y: py } = stack.pop();
                if (px < 0 || px >= CANVAS_SIZE || py < 0 || py >= CANVAS_SIZE) continue;

                const idx = (py * CANVAS_SIZE + px) * 4;
                if (!colorsEqual(getColorAt(data, px, py), targetColor)) continue;

                data[idx] = fillColor.r;
                data[idx + 1] = fillColor.g;
                data[idx + 2] = fillColor.b;
                data[idx + 3] = 255;

                stack.push({ x: px + 1, y: py }, { x: px - 1, y: py }, { x: px, y: py + 1 }, { x: px, y: py - 1 });
            }

            ctx.putImageData(imageData, 0, 0);
        }

        function getColorAt(data, x, y) {
            const idx = (y * CANVAS_SIZE + x) * 4;
            return { r: data[idx], g: data[idx + 1], b: data[idx + 2] };
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : { r: 0, g: 0, b: 0 };
        }

        function colorsEqual(c1, c2) {
            return c1.r === c2.r && c1.g === c2.g && c1.b === c2.b;
        }

        function zoom(factor) {
            scale = Math.max(0.5, Math.min(5, scale * factor));
            skinCanvas.style.transform = `scale(${scale})`;
        }

        function resetZoom() {
            scale = 1;
            skinCanvas.style.transform = 'scale(1)';
        }

        function selectTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tool="${tool}"]`).classList.add('active');
            document.getElementById('mode2d').textContent =
                tool === 'pencil' ? '‚úèÔ∏è Draw Mode' :
                    tool === 'eraser' ? 'üßπ Erase Mode' :
                        tool === 'fill' ? 'üé® Fill Mode' : 'üíâ Pick Color';
        }

        function selectColor(color, element) {
            currentColor = color;
            document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
            if (element) element.classList.add('active');
        }

        function switchView(view) {
            const is3D = view === '3d';
            document.getElementById('btn2D').classList.toggle('active', !is3D);
            document.getElementById('btn3D').classList.toggle('active', is3D);
            document.getElementById('view2d').classList.toggle('hidden', is3D);
            document.getElementById('view3d').classList.toggle('hidden', !is3D);

            if (is3D && viewer) {
                viewer.loadSkin(getDataURL());
                updateMode3D();
            }
        }

        function toggle3DDrawMode() {
            is3DDrawMode = !is3DDrawMode;
            updateMode3D();
        }

        function updateMode3D() {
            if (!viewer) return;
            viewer.controls.enableRotate = !is3DDrawMode;
            const modeText = is3DDrawMode ? '‚úèÔ∏è Draw on Model' : 'üîÑ Rotate Mode';
            document.getElementById('mode3d').textContent = modeText;
            document.getElementById('mode3d').style.background = is3DDrawMode ? 'rgba(76, 175, 80, 0.8)' : 'rgba(0, 0, 0, 0.7)';
        }

        function on3DPointerDown(e) {
            if (!is3DDrawMode) return;
            e.preventDefault();
            painting3D = true;
            paint3D(e);
        }

        function on3DPointerMove(e) {
            if (!is3DDrawMode || !painting3D) return;
            e.preventDefault();
            paint3D(e);
        }

        function on3DPointerUp(e) {
            if (painting3D) {
                painting3D = false;
                drawGrid();
                notifyFlutter();
            }
        }

        function paint3D(e) {
            const canvas = document.getElementById('viewer3d');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // Use Three.js raycasting
            if (!viewer || !viewer.scene || !viewer.camera) return;

            // Get THREE from skinview3d
            const THREE = window.skinview3d.THREE || window.THREE;
            if (!THREE) return;

            // Normalized device coordinates
            const mouse = new THREE.Vector2(
                (x / rect.width) * 2 - 1,
                -(y / rect.height) * 2 + 1
            );

            // Create raycaster
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, viewer.camera);

            // Get all meshes from the player
            const meshes = [];
            viewer.playerObject.traverse((child) => {
                if (child.isMesh && child.material) {
                    meshes.push(child);
                }
            });

            // Raycast
            const intersects = raycaster.intersectObjects(meshes);

            if (intersects.length > 0) {
                const hit = intersects[0];
                const uv = hit.uv;

                if (uv) {
                    // Map UV to 64x64 texture
                    const px = Math.floor(uv.x * SKIN_SIZE);
                    const py = Math.floor((1 - uv.y) * SKIN_SIZE); // Flip Y

                    if (px >= 0 && px < SKIN_SIZE && py >= 0 && py < SKIN_SIZE) {
                        ctx.fillStyle = currentTool === 'eraser' ? '#C8C8C8' : currentColor;
                        ctx.fillRect(px * PIXEL_SIZE, py * PIXEL_SIZE, PIXEL_SIZE, PIXEL_SIZE);
                        viewer.loadSkin(getDataURL());
                    }
                }
            }
        }

        function getDataURL() {
            const temp = document.createElement('canvas');
            temp.width = SKIN_SIZE;
            temp.height = SKIN_SIZE;
            temp.getContext('2d').drawImage(skinCanvas, 0, 0, CANVAS_SIZE, CANVAS_SIZE, 0, 0, SKIN_SIZE, SKIN_SIZE);
            return temp.toDataURL();
        }

        function notifyFlutter() {
            if (window.FlutterChannel) {
                const dataURL = getDataURL();
                window.FlutterChannel.postMessage(JSON.stringify({
                    type: 'skin_update',
                    data: dataURL.split(',')[1]
                }));
            }
        }

        function loadSkin(base64Data) {
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
                ctx.drawImage(img, 0, 0, SKIN_SIZE, SKIN_SIZE, 0, 0, CANVAS_SIZE, CANVAS_SIZE);
                drawGrid();
                if (viewer) viewer.loadSkin(getDataURL());
            };
            img.src = 'data:image/png;base64,' + base64Data;
        }

        // Expose to Flutter
        window.loadSkin = loadSkin;

        // Initialize on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>

</html>